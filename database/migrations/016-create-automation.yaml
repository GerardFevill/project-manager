databaseChangeLog:
  # Automation for Jira - Rules, Triggers, Actions, Conditions

  - changeSet:
      id: 016-create-automation-rule
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: state
                  type: VARCHAR(50)
                  remarks: "ENABLED, DISABLED"
              - column:
                  name: created_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: updated_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP

  - changeSet:
      id: 016-create-rule-trigger
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_trigger
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: trigger_type
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: configuration
                  type: TEXT

  - changeSet:
      id: 016-create-rule-condition
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_condition
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: condition_type
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: configuration
                  type: TEXT
              - column:
                  name: position
                  type: INTEGER

  - changeSet:
      id: 016-create-rule-action
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_action
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: action_type
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: configuration
                  type: TEXT
              - column:
                  name: position
                  type: INTEGER

  - changeSet:
      id: 016-create-rule-audit
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_audit
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: actor_key
                  type: VARCHAR(255)
              - column:
                  name: action
                  type: VARCHAR(100)
              - column:
                  name: action_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP

  - changeSet:
      id: 016-create-rule-statistic
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_statistic
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: execution_count
                  type: BIGINT
                  defaultValueNumeric: 0
              - column:
                  name: success_count
                  type: BIGINT
                  defaultValueNumeric: 0
              - column:
                  name: failure_count
                  type: BIGINT
                  defaultValueNumeric: 0
              - column:
                  name: last_execution
                  type: TIMESTAMP

  - changeSet:
      id: 016-create-rule-variable
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_variable
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: variable_name
                  type: VARCHAR(255)
              - column:
                  name: variable_type
                  type: VARCHAR(100)
              - column:
                  name: default_value
                  type: TEXT

  - changeSet:
      id: 016-create-rule-project
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_project
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: project_id
                  type: BIGINT
                  constraints:
                    foreignKeyName: fk_auto_rp_project
                    references: project(id)

  - changeSet:
      id: 016-create-rule-event
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_event
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: event_type
                  type: VARCHAR(255)

  - changeSet:
      id: 016-create-rule-template
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_template
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: template_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: template_config
                  type: TEXT

  - changeSet:
      id: 016-create-rule-template-item
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_template_item
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: template_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: item_config
                  type: TEXT

  - changeSet:
      id: 016-create-rule-template-param
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_template_param
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: template_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: param_name
                  type: VARCHAR(255)
              - column:
                  name: param_value
                  type: TEXT

  - changeSet:
      id: 016-create-rule-schedule
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_schedule
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: cron_expression
                  type: VARCHAR(255)
              - column:
                  name: next_run
                  type: TIMESTAMP

  - changeSet:
      id: 016-create-rule-history
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_history
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: execution_id
                  type: VARCHAR(255)
              - column:
                  name: started_date
                  type: TIMESTAMP
              - column:
                  name: completed_date
                  type: TIMESTAMP
              - column:
                  name: status
                  type: VARCHAR(50)

  - changeSet:
      id: 016-create-rule-execution
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_execution
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: execution_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: duration_ms
                  type: BIGINT
              - column:
                  name: status
                  type: VARCHAR(50)

  - changeSet:
      id: 016-create-rule-error
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_error
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: execution_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: error_message
                  type: TEXT
              - column:
                  name: stack_trace
                  type: TEXT
              - column:
                  name: error_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP

  - changeSet:
      id: 016-create-rule-queue
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_queue
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: queue_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: processed
                  type: BOOLEAN
                  defaultValueBoolean: false

  - changeSet:
      id: 016-create-rule-trigger-log
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_trigger_log
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: trigger_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: trigger_data
                  type: TEXT

  - changeSet:
      id: 016-create-rule-trigger-history
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_trigger_history
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: triggered_date
                  type: TIMESTAMP
              - column:
                  name: issue_id
                  type: BIGINT
                  constraints:
                    foreignKeyName: fk_auto_rth_issue
                    references: jira_issue(id)

  - changeSet:
      id: 016-create-rule-run
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_run
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: run_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: success
                  type: BOOLEAN

  - changeSet:
      id: 016-create-rule-run-log
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_run_log
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: run_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: log_message
                  type: TEXT
              - column:
                  name: log_level
                  type: VARCHAR(50)

  - changeSet:
      id: 016-create-rule-run-history
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_run_history
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: run_date
                  type: TIMESTAMP
              - column:
                  name: actions_executed
                  type: INTEGER

  - changeSet:
      id: 016-create-rule-variable-value
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_variable_value
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: variable_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: execution_id
                  type: BIGINT
              - column:
                  name: value
                  type: TEXT

  - changeSet:
      id: 016-create-rule-variable-type
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_variable_type
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: type_name
                  type: VARCHAR(255)
              - column:
                  name: type_class
                  type: VARCHAR(255)

  - changeSet:
      id: 016-create-rule-project-scope
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_project_scope
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: project_id
                  type: BIGINT
                  constraints:
                    foreignKeyName: fk_auto_rps_project
                    references: project(id)

  - changeSet:
      id: 016-create-rule-workflow-scope
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_workflow_scope
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: workflow_id
                  type: BIGINT

  - changeSet:
      id: 016-create-rule-audit-detail
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_audit_detail
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: audit_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: detail_key
                  type: VARCHAR(255)
              - column:
                  name: detail_value
                  type: TEXT

  - changeSet:
      id: 016-create-rule-execution-queue
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_execution_queue
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: queued_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: priority
                  type: INTEGER

  - changeSet:
      id: 016-create-rule-execution-lock
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_execution_lock
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: locked_at
                  type: TIMESTAMP
              - column:
                  name: locked_by
                  type: VARCHAR(255)

  - changeSet:
      id: 016-create-rule-lock
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_lock
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: lock_key
                  type: VARCHAR(255)

  - changeSet:
      id: 016-create-rule-cron
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_cron
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: cron_expression
                  type: VARCHAR(255)
              - column:
                  name: timezone
                  type: VARCHAR(100)

  - changeSet:
      id: 016-create-rule-template-scope
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_template_scope
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: template_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: scope_type
                  type: VARCHAR(100)

  - changeSet:
      id: 016-create-rule-function
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_function
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: function_name
                  type: VARCHAR(255)
              - column:
                  name: function_body
                  type: TEXT

  - changeSet:
      id: 016-create-rule-function-param
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_function_param
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: function_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: param_name
                  type: VARCHAR(255)
              - column:
                  name: param_type
                  type: VARCHAR(100)

  - changeSet:
      id: 016-create-rule-script
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_script
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: script_content
                  type: TEXT

  - changeSet:
      id: 016-create-rule-script-log
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_script_log
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: script_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: execution_date
                  type: TIMESTAMP
              - column:
                  name: output
                  type: TEXT

  - changeSet:
      id: 016-create-rule-env
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_env
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: env_key
                  type: VARCHAR(255)
              - column:
                  name: env_value
                  type: TEXT

  - changeSet:
      id: 016-create-rule-env-param
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_env_param
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: env_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: param_name
                  type: VARCHAR(255)
              - column:
                  name: param_value
                  type: TEXT

  - changeSet:
      id: 016-create-rule-stats
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_stats
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: stat_date
                  type: DATE
              - column:
                  name: execution_count
                  type: INTEGER

  - changeSet:
      id: 016-create-rule-stats-agg
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_stats_agg
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: period_type
                  type: VARCHAR(50)
              - column:
                  name: total_executions
                  type: BIGINT

  - changeSet:
      id: 016-create-rule-stats-hist
      author: system
      changes:
        - createTable:
            tableName: ao_58984e_rule_stats_hist
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: rule_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: snapshot_date
                  type: TIMESTAMP
              - column:
                  name: executions
                  type: INTEGER
              - column:
                  name: failures
                  type: INTEGER
