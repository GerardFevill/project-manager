databaseChangeLog:
  - changeSet:
      id: 003-enhance-tasks-table
      author: GerardFevill
      comment: Add advanced task management features (status, progress, recurrence, tags, metadata)
      changes:
        # Add status enum column (replaces completed boolean)
        - addColumn:
            tableName: tasks
            columns:
              - column:
                  name: status
                  type: varchar(20)
                  defaultValue: draft
                  constraints:
                    nullable: false

        # Add check constraint for status enum
        - sql:
            sql: >
              ALTER TABLE tasks
              ADD CONSTRAINT chk_tasks_status
              CHECK (status IN ('draft', 'active', 'completed', 'blocked', 'recurring', 'archived'));

        # Add progress column (0-100%)
        - addColumn:
            tableName: tasks
            columns:
              - column:
                  name: progress
                  type: integer
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false

        # Add check constraint for progress range
        - sql:
            sql: >
              ALTER TABLE tasks
              ADD CONSTRAINT chk_tasks_progress
              CHECK (progress >= 0 AND progress <= 100);

        # Add recurrence column
        - addColumn:
            tableName: tasks
            columns:
              - column:
                  name: recurrence
                  type: varchar(20)
                  defaultValue: none
                  constraints:
                    nullable: false

        # Add check constraint for recurrence enum
        - sql:
            sql: >
              ALTER TABLE tasks
              ADD CONSTRAINT chk_tasks_recurrence
              CHECK (recurrence IN ('none', 'daily', 'weekly', 'monthly', 'yearly'));

        # Add recurrence-related timestamp columns
        - addColumn:
            tableName: tasks
            columns:
              - column:
                  name: nextOccurrence
                  type: timestamp
                  constraints:
                    nullable: true
              - column:
                  name: lastOccurrence
                  type: timestamp
                  constraints:
                    nullable: true

        # Add start date column
        - addColumn:
            tableName: tasks
            columns:
              - column:
                  name: startDate
                  type: timestamp
                  constraints:
                    nullable: true

        # Add tags array (using text with simple-array TypeORM)
        - addColumn:
            tableName: tasks
            columns:
              - column:
                  name: tags
                  type: text
                  constraints:
                    nullable: true

        # Add metadata JSONB column for flexible data storage
        - addColumn:
            tableName: tasks
            columns:
              - column:
                  name: metadata
                  type: jsonb
                  constraints:
                    nullable: true

        # Add time tracking columns
        - addColumn:
            tableName: tasks
            columns:
              - column:
                  name: estimatedHours
                  type: numeric(6,2)
                  constraints:
                    nullable: true
              - column:
                  name: actualHours
                  type: numeric(6,2)
                  constraints:
                    nullable: true

        # Add soft delete timestamp
        - addColumn:
            tableName: tasks
            columns:
              - column:
                  name: deletedAt
                  type: timestamp
                  constraints:
                    nullable: true

        # Migrate existing completed boolean to status
        - sql:
            sql: >
              UPDATE tasks
              SET status = CASE
                WHEN completed = true THEN 'completed'
                ELSE 'active'
              END;

        # Drop old completed column (replaced by status)
        - dropColumn:
            tableName: tasks
            columnName: completed

      rollback:
        # Restore completed column
        - addColumn:
            tableName: tasks
            columns:
              - column:
                  name: completed
                  type: boolean
                  defaultValueBoolean: false
        # Migrate status back to completed
        - sql:
            sql: >
              UPDATE tasks
              SET completed = CASE
                WHEN status = 'completed' THEN true
                ELSE false
              END;
        # Drop all added columns
        - dropColumn:
            tableName: tasks
            columnName: status
        - dropColumn:
            tableName: tasks
            columnName: progress
        - dropColumn:
            tableName: tasks
            columnName: recurrence
        - dropColumn:
            tableName: tasks
            columnName: nextOccurrence
        - dropColumn:
            tableName: tasks
            columnName: lastOccurrence
        - dropColumn:
            tableName: tasks
            columnName: startDate
        - dropColumn:
            tableName: tasks
            columnName: tags
        - dropColumn:
            tableName: tasks
            columnName: metadata
        - dropColumn:
            tableName: tasks
            columnName: estimatedHours
        - dropColumn:
            tableName: tasks
            columnName: actualHours
        - dropColumn:
            tableName: tasks
            columnName: deletedAt
