databaseChangeLog:
  - changeSet:
      id: 022-create-scriptrunner-tables
      author: system
      changes:
        # ScriptRunner - Script and automation management

        # Script Registry
        - createTable:
            tableName: ao_90c7dc_scriptrunner_script
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: script_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: script_type
                  type: VARCHAR(100)
                  constraints:
                    nullable: false
              - column:
                  name: script_content
                  type: TEXT
              - column:
                  name: language
                  type: VARCHAR(50)
                  defaultValue: 'groovy'
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: enabled
                  type: BOOLEAN
                  defaultValueBoolean: true
              - column:
                  name: created_by
                  type: VARCHAR(255)
              - column:
                  name: created_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: updated_date
                  type: TIMESTAMP

        # Script Parameters
        - createTable:
            tableName: ao_90c7dc_script_param
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: script_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: param_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: param_type
                  type: VARCHAR(100)
              - column:
                  name: param_value
                  type: TEXT
              - column:
                  name: required
                  type: BOOLEAN
                  defaultValueBoolean: false

        # Script Execution History
        - createTable:
            tableName: ao_90c7dc_script_execution
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: script_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: executed_by
                  type: VARCHAR(255)
              - column:
                  name: execution_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: execution_time_ms
                  type: BIGINT
              - column:
                  name: status
                  type: VARCHAR(50)
              - column:
                  name: result
                  type: TEXT
              - column:
                  name: error_message
                  type: TEXT
              - column:
                  name: stack_trace
                  type: TEXT

        # Script Listeners
        - createTable:
            tableName: ao_90c7dc_script_listener
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: listener_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: script_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: event_type
                  type: VARCHAR(255)
              - column:
                  name: project_id
                  type: BIGINT
              - column:
                  name: enabled
                  type: BOOLEAN
                  defaultValueBoolean: true
              - column:
                  name: order_num
                  type: INTEGER
              - column:
                  name: condition_script
                  type: TEXT

        # Script Fields (Custom Fields)
        - createTable:
            tableName: ao_90c7dc_script_field
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: field_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: field_name
                  type: VARCHAR(255)
              - column:
                  name: script_id
                  type: BIGINT
              - column:
                  name: template
                  type: TEXT
              - column:
                  name: searcher_script_id
                  type: BIGINT
              - column:
                  name: velocity_template
                  type: TEXT

        # Scripted JQL Functions
        - createTable:
            tableName: ao_90c7dc_jql_function
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: function_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: script_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: enabled
                  type: BOOLEAN
                  defaultValueBoolean: true
              - column:
                  name: arg_count
                  type: INTEGER

        # Script Fragments
        - createTable:
            tableName: ao_90c7dc_script_fragment
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: fragment_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: location
                  type: VARCHAR(255)
              - column:
                  name: script_id
                  type: BIGINT
              - column:
                  name: weight
                  type: INTEGER
              - column:
                  name: enabled
                  type: BOOLEAN
                  defaultValueBoolean: true

        # REST Endpoints
        - createTable:
            tableName: ao_90c7dc_rest_endpoint
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: endpoint_path
                  type: VARCHAR(500)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: http_method
                  type: VARCHAR(20)
                  constraints:
                    nullable: false
              - column:
                  name: script_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: enabled
                  type: BOOLEAN
                  defaultValueBoolean: true
              - column:
                  name: auth_required
                  type: BOOLEAN
                  defaultValueBoolean: true
              - column:
                  name: allowed_groups
                  type: TEXT

        # REST Endpoint Execution Log
        - createTable:
            tableName: ao_90c7dc_rest_execution
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: endpoint_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: request_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: user_key
                  type: VARCHAR(255)
              - column:
                  name: request_params
                  type: TEXT
              - column:
                  name: response_status
                  type: INTEGER
              - column:
                  name: response_body
                  type: TEXT
              - column:
                  name: execution_time_ms
                  type: BIGINT

        # Scheduled Jobs
        - createTable:
            tableName: ao_90c7dc_scheduled_job
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: job_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: script_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: cron_expression
                  type: VARCHAR(255)
              - column:
                  name: enabled
                  type: BOOLEAN
                  defaultValueBoolean: true
              - column:
                  name: last_run
                  type: TIMESTAMP
              - column:
                  name: next_run
                  type: TIMESTAMP
              - column:
                  name: run_as_user
                  type: VARCHAR(255)

        # Job Execution History
        - createTable:
            tableName: ao_90c7dc_job_execution
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: job_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: start_time
                  type: TIMESTAMP
              - column:
                  name: end_time
                  type: TIMESTAMP
              - column:
                  name: status
                  type: VARCHAR(50)
              - column:
                  name: result
                  type: TEXT
              - column:
                  name: error_message
                  type: TEXT

        # Script Console History
        - createTable:
            tableName: ao_90c7dc_console_history
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: user_key
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: script_content
                  type: TEXT
              - column:
                  name: execution_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: execution_time_ms
                  type: BIGINT
              - column:
                  name: result
                  type: TEXT
              - column:
                  name: error
                  type: TEXT

        # Enhanced Search
        - createTable:
            tableName: ao_90c7dc_enhanced_search
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: search_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: script_id
                  type: BIGINT
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: enabled
                  type: BOOLEAN
                  defaultValueBoolean: true

        # Script Validators
        - createTable:
            tableName: ao_90c7dc_script_validator
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: validator_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: workflow_id
                  type: BIGINT
              - column:
                  name: transition_id
                  type: BIGINT
              - column:
                  name: script_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: error_message
                  type: TEXT
              - column:
                  name: order_num
                  type: INTEGER

        # Script Conditions
        - createTable:
            tableName: ao_90c7dc_script_condition
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: condition_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: workflow_id
                  type: BIGINT
              - column:
                  name: transition_id
                  type: BIGINT
              - column:
                  name: script_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: order_num
                  type: INTEGER

        # Script Post Functions
        - createTable:
            tableName: ao_90c7dc_script_postfunction
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: function_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: workflow_id
                  type: BIGINT
              - column:
                  name: transition_id
                  type: BIGINT
              - column:
                  name: script_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: order_num
                  type: INTEGER

        # Behaviours
        - createTable:
            tableName: ao_90c7dc_behaviour
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: behaviour_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: project_id
                  type: BIGINT
              - column:
                  name: issue_type_id
                  type: BIGINT
              - column:
                  name: enabled
                  type: BOOLEAN
                  defaultValueBoolean: true
              - column:
                  name: order_num
                  type: INTEGER

        # Behaviour Fields
        - createTable:
            tableName: ao_90c7dc_behaviour_field
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: behaviour_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: field_id
                  type: VARCHAR(255)
              - column:
                  name: script_id
                  type: BIGINT
              - column:
                  name: always_execute
                  type: BOOLEAN
                  defaultValueBoolean: false

        # Escalation Service
        - createTable:
            tableName: ao_90c7dc_escalation
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: escalation_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: jql_query
                  type: TEXT
              - column:
                  name: script_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: interval_minutes
                  type: INTEGER
              - column:
                  name: enabled
                  type: BOOLEAN
                  defaultValueBoolean: true
              - column:
                  name: last_run
                  type: TIMESTAMP

        # Escalation Execution
        - createTable:
            tableName: ao_90c7dc_escalation_exec
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: escalation_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: execution_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: issues_processed
                  type: INTEGER
              - column:
                  name: status
                  type: VARCHAR(50)
              - column:
                  name: error_message
                  type: TEXT

        # Script Registry Metadata
        - createTable:
            tableName: ao_90c7dc_script_metadata
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: script_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: meta_key
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: meta_value
                  type: TEXT

        # Built-in Scripts
        - createTable:
            tableName: ao_90c7dc_builtin_script
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: script_key
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: script_name
                  type: VARCHAR(255)
              - column:
                  name: category
                  type: VARCHAR(100)
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: enabled
                  type: BOOLEAN
                  defaultValueBoolean: true

        # Script Links (Issue Links)
        - createTable:
            tableName: ao_90c7dc_script_link
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: link_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: link_type
                  type: VARCHAR(100)
              - column:
                  name: script_id
                  type: BIGINT
              - column:
                  name: location
                  type: VARCHAR(255)
              - column:
                  name: enabled
                  type: BOOLEAN
                  defaultValueBoolean: true

        # Mail Handlers
        - createTable:
            tableName: ao_90c7dc_mail_handler
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: handler_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: script_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: enabled
                  type: BOOLEAN
                  defaultValueBoolean: true
              - column:
                  name: order_num
                  type: INTEGER

        # Script Services
        - createTable:
            tableName: ao_90c7dc_script_service
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: service_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: service_class
                  type: VARCHAR(500)
              - column:
                  name: script_id
                  type: BIGINT
              - column:
                  name: enabled
                  type: BOOLEAN
                  defaultValueBoolean: true

        # Fast-Track Transitions
        - createTable:
            tableName: ao_90c7dc_fast_track
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: transition_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: from_status
                  type: VARCHAR(255)
              - column:
                  name: to_status
                  type: VARCHAR(255)
              - column:
                  name: script_id
                  type: BIGINT
              - column:
                  name: enabled
                  type: BOOLEAN
                  defaultValueBoolean: true

        # Script Binding Registry
        - createTable:
            tableName: ao_90c7dc_binding
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: binding_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: binding_class
                  type: VARCHAR(500)
              - column:
                  name: script_id
                  type: BIGINT

        # Script Event Types
        - createTable:
            tableName: ao_90c7dc_event_type
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: event_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: event_type
                  type: VARCHAR(100)
              - column:
                  name: template_id
                  type: BIGINT
              - column:
                  name: description
                  type: TEXT

        # Script Resources
        - createTable:
            tableName: ao_90c7dc_script_resource
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: resource_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: resource_type
                  type: VARCHAR(100)
              - column:
                  name: resource_content
                  type: TEXT
              - column:
                  name: script_id
                  type: BIGINT

        # Global Bindings
        - createTable:
            tableName: ao_90c7dc_global_binding
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: binding_key
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: binding_value
                  type: TEXT
              - column:
                  name: value_type
                  type: VARCHAR(100)

        # Script Audit Log
        - createTable:
            tableName: ao_90c7dc_audit_log
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: script_id
                  type: BIGINT
              - column:
                  name: action_type
                  type: VARCHAR(100)
              - column:
                  name: user_key
                  type: VARCHAR(255)
              - column:
                  name: action_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: details
                  type: TEXT

        # Script Permission
        - createTable:
            tableName: ao_90c7dc_script_permission
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: script_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: permission_type
                  type: VARCHAR(100)
              - column:
                  name: group_name
                  type: VARCHAR(255)
              - column:
                  name: user_key
                  type: VARCHAR(255)
