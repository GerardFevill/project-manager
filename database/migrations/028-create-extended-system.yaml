databaseChangeLog:
  - changeSet:
      id: 028-create-extended-system-tables
      author: system
      changes:
        # Extended System Tables - Cache, Monitoring, Advanced Features

        # Advanced Cache Management
        - createTable:
            tableName: query_cache
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: cache_key
                  type: VARCHAR(500)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: cache_value
                  type: TEXT
              - column:
                  name: created_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: expiry_date
                  type: TIMESTAMP
              - column:
                  name: hit_count
                  type: INTEGER
                  defaultValue: '0'

        # Session Cache
        - createTable:
            tableName: session_cache
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: session_id
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: user_key
                  type: VARCHAR(255)
              - column:
                  name: session_data
                  type: TEXT
              - column:
                  name: created_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: last_accessed
                  type: TIMESTAMP
              - column:
                  name: expiry_date
                  type: TIMESTAMP

        # Distributed Cache Nodes
        - createTable:
            tableName: distributed_cache_node
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: node_id
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: node_address
                  type: VARCHAR(500)
              - column:
                  name: status
                  type: VARCHAR(50)
              - column:
                  name: last_heartbeat
                  type: TIMESTAMP
              - column:
                  name: cache_size_mb
                  type: INTEGER

        # Performance Monitoring
        - createTable:
            tableName: performance_log
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: metric_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: metric_value
                  type: DECIMAL(20,4)
              - column:
                  name: metric_unit
                  type: VARCHAR(50)
              - column:
                  name: recorded_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: node_id
                  type: VARCHAR(255)

        # System Health Check
        - createTable:
            tableName: health_check_log
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: check_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: check_status
                  type: VARCHAR(50)
              - column:
                  name: check_message
                  type: TEXT
              - column:
                  name: check_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: duration_ms
                  type: BIGINT

        # Request Metrics
        - createTable:
            tableName: request_metric
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: request_path
                  type: VARCHAR(1000)
              - column:
                  name: request_method
                  type: VARCHAR(20)
              - column:
                  name: response_status
                  type: INTEGER
              - column:
                  name: duration_ms
                  type: BIGINT
              - column:
                  name: user_key
                  type: VARCHAR(255)
              - column:
                  name: request_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP

        # Database Connection Pool
        - createTable:
            tableName: db_connection_pool
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: pool_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: active_connections
                  type: INTEGER
              - column:
                  name: idle_connections
                  type: INTEGER
              - column:
                  name: max_connections
                  type: INTEGER
              - column:
                  name: recorded_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP

        # Error Tracking
        - createTable:
            tableName: error_tracking
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: error_hash
                  type: VARCHAR(255)
              - column:
                  name: error_message
                  type: TEXT
              - column:
                  name: stack_trace
                  type: TEXT
              - column:
                  name: occurrence_count
                  type: INTEGER
                  defaultValue: '1'
              - column:
                  name: first_seen
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: last_seen
                  type: TIMESTAMP
              - column:
                  name: severity
                  type: VARCHAR(50)

        # Feature Flag History
        - createTable:
            tableName: feature_flag_history
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: flag_key
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: enabled
                  type: BOOLEAN
              - column:
                  name: changed_by
                  type: VARCHAR(255)
              - column:
                  name: changed_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: reason
                  type: TEXT

        # Rate Limit Buckets
        - createTable:
            tableName: rate_limit_bucket
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: identifier
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: bucket_type
                  type: VARCHAR(100)
              - column:
                  name: tokens_remaining
                  type: INTEGER
              - column:
                  name: reset_time
                  type: TIMESTAMP
              - column:
                  name: last_request
                  type: TIMESTAMP

        # API Rate Limit Log
        - createTable:
            tableName: api_rate_limit_log
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: user_key
                  type: VARCHAR(255)
              - column:
                  name: api_endpoint
                  type: VARCHAR(500)
              - column:
                  name: request_count
                  type: INTEGER
              - column:
                  name: window_start
                  type: TIMESTAMP
              - column:
                  name: window_end
                  type: TIMESTAMP
              - column:
                  name: throttled
                  type: BOOLEAN
                  defaultValueBoolean: false

        # Background Job Queue
        - createTable:
            tableName: background_job_queue
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: job_type
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: job_payload
                  type: TEXT
              - column:
                  name: priority
                  type: INTEGER
                  defaultValue: '5'
              - column:
                  name: status
                  type: VARCHAR(50)
              - column:
                  name: attempts
                  type: INTEGER
                  defaultValue: '0'
              - column:
                  name: created_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: scheduled_for
                  type: TIMESTAMP
              - column:
                  name: started_at
                  type: TIMESTAMP
              - column:
                  name: completed_at
                  type: TIMESTAMP
              - column:
                  name: error_message
                  type: TEXT

        # Webhook Retry Queue
        - createTable:
            tableName: webhook_retry_queue
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: webhook_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: payload
                  type: TEXT
              - column:
                  name: retry_count
                  type: INTEGER
                  defaultValue: '0'
              - column:
                  name: next_retry
                  type: TIMESTAMP
              - column:
                  name: last_error
                  type: TEXT

        # Geo Location Cache
        - createTable:
            tableName: geo_location_cache
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: ip_address
                  type: VARCHAR(100)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: country_code
                  type: VARCHAR(10)
              - column:
                  name: country_name
                  type: VARCHAR(255)
              - column:
                  name: city
                  type: VARCHAR(255)
              - column:
                  name: latitude
                  type: DECIMAL(10,7)
              - column:
                  name: longitude
                  type: DECIMAL(10,7)
              - column:
                  name: cached_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP

        # Email Bounce Log
        - createTable:
            tableName: email_bounce_log
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: email_address
                  type: VARCHAR(500)
                  constraints:
                    nullable: false
              - column:
                  name: bounce_type
                  type: VARCHAR(100)
              - column:
                  name: bounce_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: bounce_reason
                  type: TEXT
              - column:
                  name: is_permanent
                  type: BOOLEAN
                  defaultValueBoolean: false

        # Security Audit Extended
        - createTable:
            tableName: security_audit_extended
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: event_type
                  type: VARCHAR(100)
              - column:
                  name: user_key
                  type: VARCHAR(255)
              - column:
                  name: ip_address
                  type: VARCHAR(100)
              - column:
                  name: user_agent
                  type: TEXT
              - column:
                  name: event_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: resource_type
                  type: VARCHAR(100)
              - column:
                  name: resource_id
                  type: BIGINT
              - column:
                  name: action_result
                  type: VARCHAR(50)
              - column:
                  name: details
                  type: TEXT

        # License Usage Tracking
        - createTable:
            tableName: license_usage_tracking
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: tracking_date
                  type: DATE
                  constraints:
                    nullable: false
              - column:
                  name: active_users
                  type: INTEGER
              - column:
                  name: total_users
                  type: INTEGER
              - column:
                  name: license_type
                  type: VARCHAR(100)
              - column:
                  name: features_used
                  type: TEXT

        # Async Task Result
        - createTable:
            tableName: async_task_result
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: task_id
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: task_type
                  type: VARCHAR(100)
              - column:
                  name: result_data
                  type: TEXT
              - column:
                  name: status
                  type: VARCHAR(50)
              - column:
                  name: created_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: completed_date
                  type: TIMESTAMP
              - column:
                  name: error_message
                  type: TEXT

        # Data Retention Policy
        - createTable:
            tableName: data_retention_policy
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: policy_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: table_name
                  type: VARCHAR(255)
              - column:
                  name: retention_days
                  type: INTEGER
              - column:
                  name: enabled
                  type: BOOLEAN
                  defaultValueBoolean: true
              - column:
                  name: last_cleanup
                  type: TIMESTAMP
