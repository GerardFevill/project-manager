databaseChangeLog:
  - changeSet:
      id: 004-create-task-history
      author: GerardFevill
      comment: Create task_history table for audit trail and action tracking
      changes:
        - createTable:
            tableName: task_history
            columns:
              - column:
                  name: id
                  type: uuid
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
                    nullable: false

              - column:
                  name: taskId
                  type: uuid
                  constraints:
                    nullable: false
                    foreignKeyName: fk_task_history_task
                    references: tasks(id)
                    deleteCascade: true

              - column:
                  name: action
                  type: varchar(50)
                  constraints:
                    nullable: false

              - column:
                  name: statusAtExecution
                  type: varchar(20)
                  constraints:
                    nullable: false

              - column:
                  name: progressAtExecution
                  type: integer
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false

              - column:
                  name: duration
                  type: integer
                  constraints:
                    nullable: true

              - column:
                  name: metadata
                  type: jsonb
                  constraints:
                    nullable: true

              - column:
                  name: executedAt
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false

        # Indexes for query performance
        - createIndex:
            indexName: idx_task_history_taskId
            tableName: task_history
            columns:
              - column:
                  name: taskId

        - createIndex:
            indexName: idx_task_history_executedAt
            tableName: task_history
            columns:
              - column:
                  name: executedAt
                  descending: true

        - createIndex:
            indexName: idx_task_history_action
            tableName: task_history
            columns:
              - column:
                  name: action

        # Composite index for common query patterns
        - createIndex:
            indexName: idx_task_history_task_executed
            tableName: task_history
            columns:
              - column:
                  name: taskId
              - column:
                  name: executedAt
                  descending: true

      rollback:
        - dropTable:
            tableName: task_history
